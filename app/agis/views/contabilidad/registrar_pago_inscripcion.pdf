{{from agiscore.db.pago import cantidad_avonada}}
{{from agiscore.db import candidatura}}
{{def text(atext):
    return XML(atext.decode("utf-8"))
}}
{{
# escuela
escuela_data = db.escuela(1)
concepto = db(
    db.tipo_pago.nombre == "INSCRIÇÃO AO EXAME DE ACESSO").select().first()
# para sacar la cantidad por estado.
_per = db.persona(rows[0][20])
_est = db.estudiante(persona_id=_per.id)
_can = db.candidatura(estudiante_id=_est.id)
a_academico = db.ano_academico(_can.ano_academico_id)
inscritos = ((db.candidatura.estado_candidatura == candidatura.INSCRITO) |
             (db.candidatura.estado_candidatura == candidatura.NO_ADMITIDO) |
             (db.candidatura.estado_candidatura == candidatura.ADMITIDO))
con_deuda = (db.candidatura.estado_candidatura == candidatura.INSCRITO_CON_DEUDAS)

cantidad_incritos = candidatura.contar_candidatos(
    ano_academico_id=a_academico.id,
    condicion=inscritos)
cantidad_deuda = candidatura.contar_candidatos(
    ano_academico_id=a_academico.id,
    condicion=con_deuda)
}}
<font face='DejaVu' size='10'>
    {{if escuela_data.logo:}}
    {{(filename, stream) = db.escuela.logo.retrieve(escuela_data.logo)}}
    <center><p><img src="{{=stream.name}}" width="90" height="90"></p></center>
    {{pass}}
    <center><p><b>{{=text(escuela_data.nombre)}}</b></p></center>
    <br />
    <br />
    <center><p><b>{{=text(T('Registro de pagos (INSCRIPCIÓN)'))}}</b></p></center>
    <center><p><b>{{=text(T("Año académico"))}}: {{=a_academico.nombre}}</b></p></center>
<table width="100%" align="center">
    <thead>
        <tr>
            <th width="10%" align="right">{{=text(T('#'))}}</th>
            <th width="50%" align="left">{{=text(T('Nombre'))}}</th>
            <th width="15%" align="right">{{=text(T('Cantidad'))}}</th>
            <th width="25%" align="left">{{=text(T('Estado'))}}</th>
        </tr>
    </thead>
    <tbody>
        {{total = 0}}
        {{for r in rows:}}
            {{
            # cantidad
            cant = cantidad_avonada(db.persona(r[20]), concepto)
            total += cant
            }}
        <TR>
            <td align="right">{{=text(r[38])}}</td>
            <td>{{=text(r[19])}}</td>
            <td align="right">{{="$ {0:,.2f}".format(cant)}}</td>
            <td>{{=text(r[37])}}</td>
        </TR>
        {{pass}}
    </tbody>
</table>
{{ins_text = candidatura.candidatura_estado_represent(candidatura.INSCRITO, None)}}
{{deu_text = candidatura.candidatura_estado_represent(candidatura.INSCRITO_CON_DEUDAS, None)}}
<p align="right">{{=text("{}: {}".format(ins_text, cantidad_incritos))}}</p>
<p align="right">{{=text("{}: {}".format(deu_text, cantidad_deuda))}}</p>
<p align="right">{{=text(T("Total recaudado: $ {0:,.2f}".format(total)))}}</p>
</font>
